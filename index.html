<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charity Portal Dashboard - Phase 1</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- React & ReactDOM -->
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>

    <!-- React Router DOM (includes Remix Router) -->
    <script crossorigin src="https://unpkg.com/@remix-run/router@1.0.3/dist/router.umd.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router@6.4.3/dist/umd/react-router.production.min.js"></script>
    <script crossorigin
        src="https://unpkg.com/react-router-dom@6.4.3/dist/umd/react-router-dom.production.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone@7.23.3/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="styles.css?v=639079047528290049">
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useContext, createContext, useMemo } = React;
        const { HashRouter, Routes, Route, Link, useLocation, useNavigate } = window.ReactRouterDOM;
        // --- SVGs ---
        const IconSvg = ({ children, size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                {children}
            </svg>
        );
        const Target = ({ size }) => <IconSvg size={size}><circle cx="12" cy="12" r="10" /><circle cx="12" cy="12" r="6" /><circle cx="12" cy="12" r="2" /></IconSvg>;
        const Settings = ({ size }) => <IconSvg size={size}><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></IconSvg>;
        const Shield = ({ size }) => <IconSvg size={size}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></IconSvg>;
        const CloudLightning = ({ size }) => <IconSvg size={size}><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9" /><polyline points="13 11 9 17 15 17 11 23" /></IconSvg>;
        const MapIcon = ({ size }) => <IconSvg size={size}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21" /><line x1="9" y1="3" x2="9" y2="18" /><line x1="15" y1="6" x2="15" y2="21" /></IconSvg>;
        const ClipboardList = ({ size }) => <IconSvg size={size}><rect x="8" y="2" width="8" height="4" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><path d="M12 11h4" /><path d="M12 16h4" /><path d="M8 11h.01" /><path d="M8 16h.01" /></IconSvg>;
        const BarChart2 = ({ size }) => <IconSvg size={size}><line x1="18" y1="20" x2="18" y2="10" /><line x1="12" y1="20" x2="12" y2="4" /><line x1="6" y1="20" x2="6" y2="14" /></IconSvg>;
        const Layers = ({ size }) => <IconSvg size={size}><polygon points="12 2 2 7 12 12 22 7 12 2" /><polyline points="2 12 12 17 22 12" /><polyline points="2 17 12 22 22 17" /></IconSvg>;
        const ChevronDown = ({ size }) => <IconSvg size={size}><polyline points="6 9 12 15 18 9" /></IconSvg>;
        const ChevronRight = ({ size }) => <IconSvg size={size}><polyline points="9 18 15 12 9 6" /></IconSvg>;
        const X = ({ size }) => <IconSvg size={size}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></IconSvg>;
        const LayoutDashboard = ({ size }) => <IconSvg size={size}><rect x="3" y="3" width="7" height="9" /><rect x="14" y="3" width="7" height="5" /><rect x="14" y="12" width="7" height="9" /><rect x="3" y="16" width="7" height="5" /></IconSvg>;
        const Activity = ({ size }) => <IconSvg size={size}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></IconSvg>;
        const Users = ({ size }) => <IconSvg size={size}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></IconSvg>;
        const MenuIcon = ({ size }) => <IconSvg size={size}><line x1="3" y1="12" x2="21" y2="12" /><line x1="3" y1="6" x2="21" y2="6" /><line x1="3" y1="18" x2="21" y2="18" /></IconSvg>;

        // -----------------------------------------------------------------------------
        // Global Context / State Management
        // -----------------------------------------------------------------------------
        const AppContext = createContext();

        const AppProvider = ({ children }) => {
            const [activePage, setActivePage] = useState("Dashboard Home");
            const [activePillar, setActivePillar] = useState(null);
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [activeGlobalApp, setActiveGlobalApp] = useState(null);
            const [globalAppContext, setGlobalAppContext] = useState({});
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

            const openApp = (appId, context = {}) => {
                setActiveGlobalApp(appId);
                setGlobalAppContext(context);
                setDrawerOpen(true);
            };

            const closeDrawer = () => {
                setDrawerOpen(false);
                setTimeout(() => {
                    setActiveGlobalApp(null);
                    setGlobalAppContext({});
                }, 400); // Wait for transition
            };

            const value = {
                activePage, setActivePage,
                activePillar, setActivePillar,
                drawerOpen, openApp, closeDrawer, activeGlobalApp, globalAppContext,
                mobileMenuOpen, setMobileMenuOpen
            };

            return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
        };

        // -----------------------------------------------------------------------------
        // Data Structure
        // -----------------------------------------------------------------------------
        const NAVIGATION = {
            Pillars: [
                {
                    id: "A",
                    title: "A Purpose & Mission",
                    icon: <Target size={20} />,
                    items: [
                        { id: "A1", path: "/a1", label: "A1 Service Delivery" },
                        { id: "A2", path: "/a2", label: "A2 Inputs" },
                        { id: "A3", path: "/a3", label: "A3 Outputs" },
                        { id: "A4", path: "/a4", label: "A4 Outcomes" },
                        { id: "A5", path: "/a5", label: "A5 Impact" }
                    ]
                },
                {
                    id: "B",
                    title: "B Operations",
                    icon: <Settings size={20} />,
                    items: [
                        { id: "B1", path: "/b1", label: "B1 Finance & Grants" },
                        { id: "B2", path: "/b2", label: "B2 Fund Raising" },
                        { id: "B3", path: "/b3", label: "B3 Volunteer Management" },
                        { id: "B4", path: "/b4", label: "B4 Marketing & Communications" },
                        { id: "B5", path: "/b5", label: "B5 Human Resource" }
                    ]
                },
                {
                    id: "C",
                    title: "C Governance",
                    icon: <Shield size={20} />,
                    items: [
                        { id: "C1", path: "/c1", label: "C1 Charity Governance Code" },
                        { id: "C2", path: "/c2", label: "C2 Governance Evaluation Checklist" },
                        { id: "C3", path: "/c3", label: "C3 Standard Operating Procedures" },
                        { id: "C4", path: "/c4", label: "C4 Constitution" },
                        { id: "C5", path: "/c5", label: "C5 Terms of Reference" },
                        { id: "C6", path: "/c6", label: "C6 Strategic Plans" }
                    ]
                }
            ],
            GlobalApps: [
                { id: "D1", label: "D1 QUESTION STORMER" },
                { id: "D2", label: "D2 WAYFINDER" },
                { id: "D3", label: "D3 SURVEY" },
                { id: "D4", label: "D4 ANALYZER" }
            ]
        };

        // Helper Icon Mapper
        const getIconForPath = (path) => {
            if (path.startsWith('/a')) return <Activity size={32} />;
            if (path.startsWith('/b')) return <Users size={32} />;
            if (path.startsWith('/c')) return <Shield size={32} />;
            return <LayoutDashboard size={32} />;
        };

        // -----------------------------------------------------------------------------
        // Components
        // -----------------------------------------------------------------------------

        const Sidebar = () => {
            const { activePillar, setActivePillar } = useContext(AppContext);
            const location = useLocation();

            const toggleAccordion = (id) => {
                setActivePillar(activePillar === id ? null : id);
            };

            const handleNavigate = () => {
                const { setMobileMenuOpen } = useContext(AppContext);
                if (window.innerWidth <= 768) {
                    setMobileMenuOpen(false);
                }
            };

            // Auto-expand pillar based on current route
            useEffect(() => {
                NAVIGATION.Pillars.forEach(pillar => {
                    const match = pillar.items.find(item => item.path === location.pathname);
                    if (match) {
                        setActivePillar(pillar.id);
                    }
                });
            }, [location.pathname]);

            return (
                <aside className="sidebar">
                    <Link to="/" style={{ textDecoration: 'none', color: 'inherit', display: 'block' }}>
                        <div className="brand">
                            <div className="brand-icon"><Layers size={24} /></div>
                            Charity<span style={{ color: "var(--accent-emerald)" }}>Portal</span>
                        </div>
                    </Link>

                    <div className="nav-scroll">
                        {NAVIGATION.Pillars.map((pillar) => {
                            const isOpen = activePillar === pillar.id;
                            return (
                                <div key={pillar.id} className="nav-pillar">
                                    <div
                                        className={`pillar-header ${isOpen ? 'active' : ''}`}
                                        onClick={() => toggleAccordion(pillar.id)}
                                    >
                                        <div className="pillar-title">
                                            <i>{pillar.icon}</i>
                                            {pillar.title}
                                        </div>
                                        {isOpen ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
                                    </div>

                                    <div className={`nav-items ${isOpen ? 'open' : ''}`}>
                                        {pillar.items.map(item => {
                                            const isActive = location.pathname === item.path;
                                            return (
                                                <Link
                                                    key={item.id}
                                                    to={item.path}
                                                    className={`nav-item ${isActive ? 'active' : ''}`}
                                                    onClick={() => {
                                                        const { setMobileMenuOpen } = useContext(AppContext);
                                                        setMobileMenuOpen(false);
                                                    }}
                                                >
                                                    {item.label}
                                                </Link>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </aside>
            );
        };

        const TopBar = () => {
            const { activePage, openApp, setMobileMenuOpen } = useContext(AppContext);

            return (
                <header className="top-bar">
                    <div style={{ display: "flex", alignItems: "center", gap: "1rem" }}>
                        <button className="mobile-menu-btn" onClick={() => setMobileMenuOpen(prev => !prev)}>
                            <MenuIcon size={24} />
                        </button>
                        <div className="context-badge">
                            <div className="pulse-dot"></div>
                            ACTIVE_CONTEXT // {activePage.toUpperCase()}
                        </div>
                    </div>

                    <div className="global-dock">
                        {NAVIGATION.GlobalApps.map(app => (
                            <button
                                key={app.id}
                                className="dock-btn text-dock-btn"
                                onClick={() => openApp(app.id)}
                            >
                                {app.label}
                            </button>
                        ))}
                    </div>
                </header>
            );
        };

        // D3 Survey Component
        const D3Survey = () => {
            const { activePage } = useContext(AppContext);

            // Extract areas from NAVIGATION
            const allAreas = NAVIGATION.Pillars.flatMap(p => p.items);

            // Try to match activePage to an area
            const initialMatch = allAreas.find(a => a.label === activePage);

            const [selectedArea, setSelectedArea] = useState(initialMatch ? initialMatch.id : "A1");
            const [questions, setQuestions] = useState([]);
            const [customQuestion, setCustomQuestion] = useState("");

            // Re-generate auto questions when area changes
            useEffect(() => {
                const areaObj = allAreas.find(a => a.id === selectedArea);
                if (areaObj) {
                    const areaLabel = areaObj.label.replace(/^[A-C][1-6]\s/, '');
                    setQuestions([
                        `On a scale of 1-10, how effective is our ${areaLabel}?`,
                        `What are the key bottlenecks in our current ${areaLabel}?`,
                        `How satisfied are our stakeholders with our ${areaLabel}?`
                    ]);
                }
            }, [selectedArea]);

            const handleAddQuestion = (e) => {
                e.preventDefault();
                if (customQuestion.trim() && questions.length < 6) {
                    setQuestions([...questions, customQuestion.trim()]);
                    setCustomQuestion("");
                }
            };

            const removeCustomQuestion = (index) => {
                if (index >= 3) {
                    setQuestions(questions.filter((_, i) => i !== index));
                }
            };

            const sendWhatsApp = () => {
                const areaObj = allAreas.find(a => a.id === selectedArea);
                const areaLabel = areaObj ? areaObj.label : selectedArea;

                let message = `*Charity Portal Survey: ${areaLabel}*\n\nPlease share your thoughts on the following questions:\n\n`;
                questions.forEach((q, i) => {
                    message += `${i + 1}. ${q}\n`;
                });
                message += `\nReply with your answers!`;

                const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
                window.open(url, '_blank');
            };

            return (
                <div className="analyzer-container fade-in">
                    <p style={{ color: "var(--text-muted)", marginBottom: "1.5rem" }}>
                        Generate a quick 6-question pulse survey for any operational area.
                    </p>

                    <div style={{ marginBottom: "1.5rem" }}>
                        <label style={{ display: "block", marginBottom: "0.5rem", color: "var(--accent-cyan)", fontSize: "0.85rem", textTransform: "uppercase", letterSpacing: "0.05em" }}>
                            Select Survey Target Area
                        </label>
                        <select
                            value={selectedArea}
                            onChange={(e) => setSelectedArea(e.target.value)}
                            style={{
                                width: "100%", padding: "12px", borderRadius: "8px",
                                background: "rgba(255, 255, 255, 0.03)", border: "1px solid var(--border-color)",
                                color: "white", outline: "none", fontSize: "1rem"
                            }}
                        >
                            {allAreas.map(area => (
                                <option key={area.id} value={area.id} style={{ color: "black" }}>{area.label}</option>
                            ))}
                        </select>
                    </div>

                    <div className="insight-box" style={{ marginBottom: "1.5rem", background: "rgba(6, 182, 212, 0.1)", borderLeftColor: "var(--accent-cyan)" }}>
                        <strong>{questions.length}/6 Questions Loaded</strong><br />
                        <span style={{ fontSize: "0.85rem", color: "var(--text-muted)" }}>3 auto-generated based on the domain. Add up to 3 custom questions.</span>
                    </div>

                    <ul className="suggested-questions" style={{ marginBottom: "1.5rem" }}>
                        {questions.map((q, i) => (
                            <li key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", gap: "1rem" }}>
                                <div style={{ display: "flex", gap: "0.5rem", width: "100%" }}>
                                    <strong style={{ color: i < 3 ? "var(--accent-cyan)" : "var(--accent-emerald)" }}>
                                        Q{i + 1}:
                                    </strong>
                                    <span style={{ color: "var(--text-main)", flex: 1 }}>{q}</span>
                                </div>
                                {i >= 3 && (
                                    <button
                                        onClick={() => removeCustomQuestion(i)}
                                        style={{ background: "rgba(244, 63, 94, 0.1)", border: "1px solid rgba(244, 63, 94, 0.3)", color: "#f43f5e", cursor: "pointer", padding: "4px", borderRadius: "4px" }}
                                        title="Remove custom question"
                                    >
                                        <X size={14} />
                                    </button>
                                )}
                            </li>
                        ))}
                    </ul>

                    {questions.length < 6 && (
                        <form onSubmit={handleAddQuestion} style={{ display: "flex", gap: "0.5rem", marginBottom: "1.5rem" }}>
                            <input
                                type="text"
                                value={customQuestion}
                                onChange={(e) => setCustomQuestion(e.target.value)}
                                placeholder="Add custom query..."
                                style={{ flex: 1, padding: "10px", borderRadius: "8px", background: "rgba(0,0,0,0.3)", border: "1px solid var(--border-color)", color: "white", outline: "none" }}
                            />
                            <button
                                type="submit"
                                className="dock-btn text-dock-btn"
                                disabled={!customQuestion.trim()}
                                style={{ opacity: customQuestion.trim() ? 1 : 0.5, borderColor: "var(--accent-emerald)" }}
                            >
                                Add
                            </button>
                        </form>
                    )}

                    <button
                        onClick={sendWhatsApp}
                        style={{
                            width: "100%", padding: "14px", borderRadius: "12px",
                            background: "linear-gradient(135deg, #25D366, #128C7E)",
                            color: "white", border: "none", fontSize: "1rem", fontWeight: "600",
                            cursor: "pointer", display: "flex", justifyContent: "center", alignItems: "center", gap: "0.5rem",
                            boxShadow: "0 4px 15px rgba(37, 211, 102, 0.3)"
                        }}
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" /></svg>
                        Share via WhatsApp
                    </button>
                </div>
            );
        };

        // Context-Aware Sliding Drawer Output
        const D4Analyzer = () => {
            const { openApp } = useContext(AppContext);
            const [selectedNodes, setSelectedNodes] = useState([]);

            const allNodes = [
                { code: "A1", label: "Service Delivery" },
                { code: "A2", label: "Inputs" },
                { code: "A3", label: "Outputs" },
                { code: "A4", label: "Outcomes" },
                { code: "A5", label: "Impact" },
                { code: "B1", label: "Finance & Grants" },
                { code: "B2", label: "Fund Raising" },
                { code: "B3", label: "Volunteer Mgt" },
                { code: "B4", label: "Marketing & Comms" },
                { code: "B5", label: "HR" },
                { code: "C1", label: "Gov. Code" },
                { code: "C2", label: "Eval Checklist" },
                { code: "C3", label: "SOPs" },
                { code: "C4", label: "Constitution" },
                { code: "C5", label: "Terms of Ref" },
                { code: "C6", label: "Strategic Plans" }
            ];

            const toggleNode = (code) => {
                setSelectedNodes(prev =>
                    prev.includes(code) ? prev.filter(p => p !== code) : [...prev, code]
                );
            };

            // Evaluate Insight
            let insight = "";
            let questions = [];

            const hasA2 = selectedNodes.includes("A2");
            const hasA5 = selectedNodes.includes("A5");
            const hasB1 = selectedNodes.includes("B1");

            if (hasA2 && hasA5 && hasB1) {
                insight = "It appears that you are interested in whether the TOC (Theory of Change) is aligned with the impact and whether money was well spent.";
                questions = [
                    "How do our current inputs directly translate into our measured outcomes?",
                    "Are there gaps between our financial spending and our perceived impact?",
                    "What metrics should we establish to bridge the connection between cost and mission effectiveness?"
                ];
            } else if (selectedNodes.length > 0) {
                const names = selectedNodes.map(code => {
                    const node = allNodes.find(n => n.code === code);
                    return node ? node.label : code;
                });

                let namesStr = "";
                if (names.length === 1) namesStr = names[0];
                else if (names.length === 2) namesStr = `${names[0]} and ${names[1]}`;
                else namesStr = names.slice(0, -1).join(', ') + ', and ' + names[names.length - 1];

                insight = `It appears you are exploring the intersection of ${namesStr}. Consider how these specific components interact and influence each other.`;
                questions = [
                    `How does our approach to ${names[0]} directly impact our goals in the other selected areas?`,
                    `Are there systemic bottlenecks or misalignments between these specific pillars?`,
                    `If we significantly improved ${names[0]}, what secondary effects would we see across the related modules?`
                ];
            }

            return (
                <div className="analyzer-container fade-in">
                    <p style={{ color: "var(--text-muted)", marginBottom: "1.5rem", lineHeight: 1.6 }}>
                        Select a combination of nodes below. The portal will respond with prompts for you to consider, letting the paths reveal the destination.
                    </p>
                    <div className="nodes-grid">
                        {allNodes.map(node => (
                            <button
                                key={node.code}
                                className={`node-pill ${selectedNodes.includes(node.code) ? 'active' : ''}`}
                                onClick={() => toggleNode(node.code)}
                            >
                                <span className="node-code">{node.code}</span>
                                {node.label}
                            </button>
                        ))}
                    </div>

                    {selectedNodes.length > 0 && (
                        <div className="analyzer-result fade-in" style={{ marginTop: "3rem" }}>
                            <h4 style={{ color: "var(--accent-purple)", marginBottom: "0.75rem", fontFamily: "var(--font-mono)", textTransform: "uppercase", fontSize: "0.85rem", letterSpacing: "0.05em" }}>Analysis Synthesis</h4>
                            <div className="insight-box">
                                {insight}
                            </div>

                            <h4 style={{ color: "var(--text-main)", marginBottom: "1rem", marginTop: "2.5rem", fontWeight: 600, fontSize: "1.05rem" }}>
                                Would you like to question storm any of the following suggested questions?
                            </h4>
                            <ul className="suggested-questions">
                                {questions.map((q, idx) => (
                                    <li key={idx}>
                                        <div style={{ color: "var(--text-main)", fontWeight: 500 }}>"{q}"</div>
                                        <button className="storm-btn" onClick={() => openApp('D1', { question: q })}>
                                            <CloudLightning size={16} /> Storm This
                                        </button>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}
                </div>
            );
        };

        const D1QuestionStormer = () => {
            const { activePage, globalAppContext } = useContext(AppContext);
            const [inputValue, setInputValue] = useState("");
            const [storms, setStorms] = useState([]);

            // Generate initial prompt based on usage context or D4 passthrough
            const defaultPrompt = (globalAppContext && globalAppContext.question)
                ? globalAppContext.question
                : `How does our ${activePage} framework align with our core impact goals?`;

            useEffect(() => {
                setInputValue(defaultPrompt);
            }, [defaultPrompt]);

            const handleStorm = (qToStorm) => {
                const query = typeof qToStorm === 'string' ? qToStorm : inputValue;
                if (!query.trim()) return;

                const followUpPrompts = [
                    "What metrics would immediately prove our current hypothesis wrong?",
                    "How might a newly founded organization solve this entirely differently?",
                    "Which stakeholder group is completely missing from this equation?",
                    "If we had only 10% of our budget, how would we maintain this impact?",
                    "What is the most risky assumption embedded in our approach here?"
                ];
                const randomPrompt = followUpPrompts[Math.floor(Math.random() * followUpPrompts.length)];

                const newStorm = {
                    question: query,
                    answer: `Insight: Addressing "${query}" often reveals new strategic pathways. Try exploring the Governance cross-sections for structural answers.`,
                    link: "#/c1", // Simulated link
                    timestamp: new Date().toLocaleTimeString(),
                    suggestedQuestion: randomPrompt
                };

                setStorms([newStorm, ...storms]);
                if (typeof qToStorm !== 'string') setInputValue("");
            };

            return (
                <div className="analyzer-container fade-in">
                    <p style={{ color: "var(--text-muted)", marginBottom: "1.5rem", lineHeight: 1.6 }}>
                        Question Storming generates answers by challenging existing constraints.
                        Start with the contextual prompt or enter your own.
                    </p>

                    <div className="storm-input-group">
                        <textarea
                            className="storm-textarea textarea"
                            rows="3"
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            placeholder="Type a strategic question to storm..."
                            style={{ width: "100%", padding: "1rem", borderRadius: "8px", background: "rgba(0,0,0,0.2)", border: "1px solid var(--border-color)", color: "var(--text-main)", fontFamily: "var(--font-mono)", fontSize: "0.9rem", resize: "none" }}
                        />
                        <div style={{ display: "flex", justifyContent: "flex-end", marginTop: "1rem" }}>
                            <button className="storm-btn" onClick={handleStorm}>
                                <CloudLightning size={16} /> Storm Now
                            </button>
                        </div>
                    </div>

                    {storms.length > 0 && (
                        <div className="analyzer-result fade-in" style={{ marginTop: "3rem" }}>
                            <h4 style={{ color: "var(--accent-cyan)", marginBottom: "1.25rem", fontFamily: "var(--font-mono)", textTransform: "uppercase", fontSize: "0.85rem", letterSpacing: "0.05em" }}>Session History</h4>
                            <ul className="suggested-questions">
                                {storms.map((storm, idx) => (
                                    <li key={idx} style={{ borderLeft: "3px solid var(--accent-emerald)" }}>
                                        <div style={{ fontSize: "0.8rem", color: "var(--text-muted)", marginBottom: "0.5rem" }}>{storm.timestamp}</div>
                                        <div style={{ color: "var(--text-main)", fontWeight: 600, marginBottom: "0.5rem", fontSize: "1.05rem" }}>Q: {storm.question}</div>
                                        <div style={{ color: "var(--accent-emerald-glow)", lineHeight: 1.5 }}>A: {storm.answer}</div>
                                        <a href={storm.link} target="_blank" style={{ color: "var(--accent-cyan)", textDecoration: "none", fontSize: "0.85rem", marginTop: "0.5rem", marginBottom: "1rem", display: "inline-block", fontWeight: 600 }}>Explore Resource &rarr;</a>

                                        {storm.suggestedQuestion && (
                                            <div style={{ marginTop: "1rem", paddingTop: "1.25rem", borderTop: "1px dashed rgba(255,255,255,0.1)", width: "100%" }}>
                                                <div style={{ color: "var(--text-muted)", fontSize: "0.85rem", marginBottom: "0.5rem", textTransform: "uppercase", letterSpacing: "0.05em", fontFamily: "var(--font-mono)" }}>Suggested Next Storm</div>
                                                <div style={{ color: "var(--text-main)", fontWeight: 500, fontStyle: "italic", marginBottom: "1rem" }}>"{storm.suggestedQuestion}"</div>
                                                <button className="storm-btn" onClick={() => handleStorm(storm.suggestedQuestion)}>
                                                    <CloudLightning size={16} /> Storm This
                                                </button>
                                            </div>
                                        )}
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}
                </div>
            );
        };

        const D2Wayfinder = () => {
            return (
                <div className="analyzer-container fade-in" style={{ padding: 0, height: 'calc(100vh - 120px)', border: '1px solid var(--border-color)', borderRadius: '12px', overflow: 'hidden' }}>
                    <iframe
                        src="./wayfinder.html"
                        style={{ width: '100%', height: '100%', border: 'none' }}
                        title="D2 Wayfinder Ecosystem Mapping"
                    />
                </div>
            );
        };

        const AppDrawer = () => {
            const { drawerOpen, closeDrawer, activeGlobalApp, activePage } = useContext(AppContext);
            const appData = NAVIGATION.GlobalApps.find(app => app.id === activeGlobalApp);

            return (
                <>
                    <div className={`drawer-overlay ${drawerOpen ? 'open' : ''}`} onClick={closeDrawer}></div>
                    <div className={`drawer ${drawerOpen ? 'open' : ''} ${activeGlobalApp === 'D2' ? 'maximized' : ''}`}>

                        {appData && (
                            <div className="drawer-header">
                                <div className="drawer-title-group">
                                    <h3 style={{ color: "var(--accent-cyan)" }}>
                                        {appData.label}
                                    </h3>
                                    <div className="drawer-subtitle">Complementary Application Plugin</div>
                                </div>
                                <button className="close-btn" onClick={closeDrawer}>
                                    <X size={20} />
                                </button>
                            </div>
                        )}

                        <div className="drawer-content">
                            {activeGlobalApp === "D4" ? (
                                <D4Analyzer />
                            ) : activeGlobalApp === "D3" ? (
                                <D3Survey />
                            ) : activeGlobalApp === "D1" ? (
                                <D1QuestionStormer />
                            ) : activeGlobalApp === "D2" ? (
                                <D2Wayfinder />
                            ) : appData ? (
                                <div className="system-card">
                                    <div className="system-card-header">
                                        <span>System Analytics</span>
                                        <span>Context Ready</span>
                                    </div>
                                    <p style={{ color: "var(--text-muted)", marginBottom: "1.5rem", fontSize: "0.95rem", lineHeight: 1.6 }}>
                                        This is a structural placeholder for the <b>{appData.label}</b> application shell.
                                        In Phase 2, this will load the functional app capable of deeply analyzing context.
                                    </p>

                                    <div className="code-block">
                                        {`{
  "request": "${appData.label.toUpperCase()}_INIT",
  "status": "AWAITING_PHASE_2",
  "injected_context": {
    "current_module": "${activePage}",
    "timestamp": "${new Date().toISOString()}"
  },
  "action": "RENDER_PLACEHOLDER"
}`}
                                    </div>

                                    <div className="status-badge" style={{ marginTop: "2rem", width: "100%", justifyContent: "center" }}>
                                        <span>Cross-Pollination Engine Standing By</span>
                                    </div>
                                </div>
                            ) : (
                                <div>Loading Context...</div>
                            )}
                        </div>
                    </div>
                </>
            );
        };

        // Represents pages A1-C6
        const PlaceholderView = ({ title, pillarName }) => {
            const { setActivePage } = useContext(AppContext);
            const location = useLocation();

            useEffect(() => {
                setActivePage(title);
            }, [title, setActivePage]);

            return (
                <div className="placeholder-card" key={location.pathname}>
                    <div className="glow-circle"></div>
                    <div className="placeholder-icon">
                        {getIconForPath(location.pathname)}
                    </div>
                    <h2 className="placeholder-title">{title}</h2>
                    <p className="placeholder-subtitle">
                        Architectural shell verified. This interface route is stabilized and reserved for Phase 2 functional development of the {pillarName} module.
                    </p>

                    <div className="context-badge" style={{ marginTop: "3rem", background: "transparent", border: "1px solid var(--border-active)" }}>
                        <span className="pulse-dot"></span>
                        Route Node Established
                    </div>
                </div>
            );
        };

        const DashboardHome = () => {
            const { setActivePage } = useContext(AppContext);

            useEffect(() => {
                setActivePage("Global Overview");
            }, [setActivePage]);

            return (
                <div className="hero-welcome">
                    <div className="context-badge" style={{ marginBottom: "2rem" }}>
                        System Online
                    </div>
                    <h1>
                        Welcome to the <br />
                        <span>Charity Portal OS</span>
                    </h1>
                    <p style={{ marginBottom: "2.5rem", opacity: 0.9 }}>
                        Phase 1 constraints acknowledged. Select a pillar from the sidebar to explore the wireframes,
                        or access the <strong>Global Apps (D1-D4)</strong> from the top utility dock. These tools are linked to help you map out your organizational strategy—because you don’t pick the path because of the destination, you discover the destination because of the path.
                    </p>

                    <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(280px, 1fr))", gap: "1.5rem", width: "100%", maxWidth: "900px" }}>
                        <div style={{ background: "rgba(255,255,255,0.03)", padding: "1.5rem", borderRadius: "12px", border: "1px solid var(--border-color)", borderTop: "3px solid var(--accent-emerald)" }}>
                            <h3 style={{ color: "var(--text-main)", marginBottom: "0.5rem", display: "flex", alignItems: "center", gap: "0.5rem", fontSize: "1.1rem" }}>
                                <span style={{ color: "var(--accent-emerald)", fontFamily: "var(--font-mono)" }}>D1</span> Question Stormer
                            </h3>
                            <p style={{ fontSize: "0.9rem", color: "var(--text-muted)", lineHeight: 1.6 }}>Challenge your assumptions. Start with context-aware prompts in any domain and let the engine fire back counter-intuitive follow-ups to break mental blocks before you lock in a strategy.</p>
                        </div>

                        <div style={{ background: "rgba(255,255,255,0.03)", padding: "1.5rem", borderRadius: "12px", border: "1px solid var(--border-color)", borderTop: "3px solid var(--accent-cyan)" }}>
                            <h3 style={{ color: "var(--text-main)", marginBottom: "0.5rem", display: "flex", alignItems: "center", gap: "0.5rem", fontSize: "1.1rem" }}>
                                <span style={{ color: "var(--accent-cyan)", fontFamily: "var(--font-mono)" }}>D2</span> Wayfinder
                            </h3>
                            <p style={{ fontSize: "0.9rem", color: "var(--text-muted)", lineHeight: 1.6 }}>Visualize the broader ecosystem. This interactive force-directed map connects you to governing bodies, cross-sector stakeholders, and critical regulations to safely navigate the charity sector.</p>
                        </div>

                        <div style={{ background: "rgba(255,255,255,0.03)", padding: "1.5rem", borderRadius: "12px", border: "1px solid var(--border-color)", borderTop: "3px solid #f59e0b" }}>
                            <h3 style={{ color: "var(--text-main)", marginBottom: "0.5rem", display: "flex", alignItems: "center", gap: "0.5rem", fontSize: "1.1rem" }}>
                                <span style={{ color: "#f59e0b", fontFamily: "var(--font-mono)" }}>D3</span> Survey
                            </h3>
                            <p style={{ fontSize: "0.9rem", color: "var(--text-muted)", lineHeight: 1.6 }}>Take the pulse of your stakeholders. Automatically generate 6-question targeted surveys for any specific pillar and instantly dispatch them via WhatsApp for highly-responsive feedback.</p>
                        </div>

                        <div style={{ background: "rgba(255,255,255,0.03)", padding: "1.5rem", borderRadius: "12px", border: "1px solid var(--border-color)", borderTop: "3px solid var(--accent-purple)" }}>
                            <h3 style={{ color: "var(--text-main)", marginBottom: "0.5rem", display: "flex", alignItems: "center", gap: "0.5rem", fontSize: "1.1rem" }}>
                                <span style={{ color: "var(--accent-purple)", fontFamily: "var(--font-mono)" }}>D4</span> Analyzer
                            </h3>
                            <p style={{ fontSize: "0.9rem", color: "var(--text-muted)", lineHeight: 1.6 }}>Synthesize the noise. Cross-pollinate inputs from multiple silos (e.g., HR + Finance + Strategy) to auto-generate unique prompts that uncover hidden thematic vulnerabilities and opportunities.</p>
                        </div>
                    </div>
                </div>
            );
        };

        // Main Layout
        const Layout = () => {
            const { mobileMenuOpen, setMobileMenuOpen } = useContext(AppContext);

            return (
                <div className="app-container">
                    <div className={`mobile-overlay ${mobileMenuOpen ? 'open' : ''}`} onClick={() => setMobileMenuOpen(false)}></div>
                    <div className={`sidebar-container ${mobileMenuOpen ? 'open' : ''}`}>
                        <Sidebar />
                    </div>
                    <main className="main-wrapper">
                        <TopBar />
                        <div className="content-area">
                            <Routes>
                                <Route path="/" element={<DashboardHome />} />
                                {NAVIGATION.Pillars.flatMap(pillar =>
                                    pillar.items.map(item => (
                                        <Route
                                            key={item.id}
                                            path={item.path}
                                            element={<PlaceholderView title={item.label} pillarName={pillar.title} />}
                                        />
                                    ))
                                )}
                            </Routes>
                        </div>
                        <AppDrawer />
                    </main>
                </div>
            );
        };

        const App = () => (
            <AppProvider>
                <HashRouter>
                    <Layout />
                </HashRouter>
            </AppProvider>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>

</html>